<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowAssist - Digital Twin (CesiumJS)</title>

    <!-- Styl Cesium (Lokalny asset z public/cesium) -->
    <link href="/cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', sans-serif;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
        }

        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 300px;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 600;
            color: #00ffff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        p {
            margin: 0 0 15px 0;
            font-size: 12px;
            color: #aaa;
            line-height: 1.4;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            text-align: left;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 13px;
        }

        .btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-family: monospace;
            font-size: 24px;
            z-index: 90;
            pointer-events: none;
            text-shadow: 0 0 10px #00ffff;
        }
    </style>

    <!-- Skrypt Cesium (Lokalny asset) -->
    <script src="/cesium/Cesium.js"></script>
</head>

<body>

    <div id="loading">INITIALIZING DIGITAL TWIN...</div>

    <div id="ui-overlay">
        <h1>Metropolia V3</h1>
        <p>Prezentacja Katowic w technologii CesiumJS + Google Photorealistic 3D Tiles.</p>

        <button class="btn" onclick="flyTo('Spodek')">üìç Spodek / MCK</button>
        <button class="btn" onclick="flyTo('Silesia')">üèóÔ∏è Silesia City Center</button>
        <button class="btn" onclick="flyTo('Gwiazdy')">üè¢ Osiedle Gwiazdy</button>
        <button class="btn" onclick="flyTo('NOSPR')">üéµ Strefa Kultury / NOSPR</button>
    </div>

    <div id="cesiumContainer"></div>

    <script>
        // Konfiguracja globalna dla Cesium
        window.CESIUM_BASE_URL = '/cesium';

        // Token dostƒôpu
        const ION_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNjBhYjA0Ni03MjAzLTQyZmYtODRlNy04NmEzNWYzMWY1NDAiLCJpZCI6Mzc4OTMyLCJpYXQiOjE3Njg0NjY4NzZ9.2SOHQ4b9RBBlP_Gt4DNAD7PFOp9PD2TW2ahFcvAxnSQ';
        Cesium.Ion.defaultAccessToken = ION_TOKEN;

        // Inicjalizacja Viewera
        const viewer = new Cesium.Viewer('cesiumContainer', {
            // terrainProvider: Cesium.createWorldTerrain(), // Deprecated in new Cesium versions
            animation: false,
            timeline: false,
            baseLayerPicker: false,
            homeButton: false,
            geocoder: false,
            selectionIndicator: false,
            infoBox: false,
            navigationHelpButton: false,
            sceneModePicker: false,
            creditContainer: document.createElement("div") // Ukrycie stopki
        });

        // W≈ÇƒÖczenie g≈Çƒôbi terenu
        viewer.scene.globe.depthTestAgainstTerrain = true;

        // ≈Åadowanie Google Photorealistic 3D Tiles
        async function loadGoogleTiles() {
            try {
                const tileset = await Cesium.createGooglePhotorealistic3DTileset();
                viewer.scene.primitives.add(tileset);
                console.log('‚úÖ Google 3D Tiles za≈Çadowane.');
                document.getElementById('loading').style.display = 'none';

                // Start w Katowicach
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(19.025, 50.266, 1500),
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0.0
                    }
                });

            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd ≈Çadowania 3D Tiles:', error);
                document.getElementById('loading').innerHTML = 'B≈ÅƒÑD ≈ÅADOWANIA MAPY';
                document.getElementById('loading').style.color = 'red';
            }
        }

        loadGoogleTiles();

        // Funkcja lotu
        window.flyTo = function (target) {
            let lat, lon, height = 500;

            if (typeof target === 'object') {
                lat = target.lat;
                lon = target.lon;
                height = target.height || 500;
            } else {
                // Fallback dla string√≥w (lokalny debug)
                if (target === 'Spodek') { lat = 50.2661; lon = 19.0251; height = 400; }
                if (target === 'Silesia') { lat = 50.2705; lon = 19.0045; height = 350; }
                if (target === 'Gwiazdy') { lat = 50.2605; lon = 19.0372; height = 450; }
                if (target === 'NOSPR') { lat = 50.2629; lon = 19.0275; height = 300; }
            }

            if (!lat || !lon) {
                console.warn('Nieznany cel lub brak wsp√≥≈Çrzƒôdnych:', target);
                return;
            }

            console.log(`üöÅ FlyTo: ${lat}, ${lon}, ${height}`);

            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, height + 600),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0.0
                },
                duration: 3.0,
                easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT
            });
        };

        // --- POST MESSAGE LISTENER (From React App) ---
        window.addEventListener('message', (event) => {
            // Zabezpieczenie origin (opcjonalne w dev)
            // if (event.origin !== "http://localhost:3000") return;

            const { type, payload } = event.data;
            if (type === 'FLY_TO') {
                console.log('üì¨ Message received:', payload);
                // Assuming flyToAddress is a typo and should be flyTo
                window.flyTo(payload.target);
            }
        });

        // Expose for debug
        // Assuming flyToAddress is a typo and should be flyTo
        window.flyToAddress = window.flyTo;
    </script>
</body>

</html>