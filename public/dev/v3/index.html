<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FlowAssist - Google 3D Tiles Demo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', sans-serif;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 100;
        }

        #credits {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }

        #credits img {
            height: 24px;
        }

        .lil-gui {
            z-index: 1000 !important;
        }
    </style>
    <!-- Import map dla Three.js i 3D Tiles Renderer -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "3d-tiles-renderer": "https://unpkg.com/3d-tiles-renderer@0.3.36/src/index.js"
            }
        }
    </script>
</head>

<body>
    <div id="info">
        <h2>FlowAssist Real Estate Mode</h2>
        <p>Lokalizacja: Warszawa (Live Data)</p>
    </div>

    <!-- Wymagane przez Google Attribution -->
    <div id="credits">
        <img src="https://assets.stickpng.com/images/580b57fcd9996e24bc43c51f.png" alt="Google">
        <span style="color:white; font-size: 12px; text-shadow: 0 0 4px black;">Google 3D Tiles</span>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
        import { GoogleTilesRenderer } from '3d-tiles-renderer';

        const API_KEY = 'AIzaSyBu9Xn3jjFGHveHz7xmav-8R_7W4oby7a0';

        // Setup sceny
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000510); // Ciemny granat zamiast czerni (dla kontrastu)
        // Mgła
        scene.fog = new THREE.FogExp2(0x000510, 0.0015);

        // --- OBIEKT REFERENCYJNY (TEST) ---
        // Czerwona Kapsuła - jeśli ją widzisz, znaczy że Three.js działa poprawnie
        const debugGeo = new THREE.CapsuleGeometry(10, 30, 4, 8);
        const debugMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
        const debugMesh = new THREE.Mesh(debugGeo, debugMat);
        debugMesh.position.set(0, 0, 0); // Centrum świata
        scene.add(debugMesh);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
        // Pozycja początkowa (nad Warszawą, ale to tylko lokalne koordynaty Three.js)
        camera.position.set(0, 400, 600);

        const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true }); // LogDepthBuffer ważny dla dużej skali
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 50;
        controls.maxDistance = 1500;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; // Nie pozwalamy wejść pod ziemię

        // --- GOOGLE 3D TILES SETUP ---
        const tilesRenderer = new GoogleTilesRenderer(API_KEY);
        scene.add(tilesRenderer.group);

        // --- DIAGNOSTYKA BŁĘDÓW ---
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const response = await originalFetch(...args);
            if (!response.ok && args[0] && typeof args[0] === 'string' && args[0].includes('googleapis.com')) {
                const msg = `API Error: ${response.status} ${response.statusText}`;
                console.error(msg);
                const info = document.getElementById('info');
                if (info && !info.innerHTML.includes(msg)) {
                    info.innerHTML += `<br><br><strong style="color:#ff4444;">⚠️ ${msg}</strong><br><small>Włącz "Map Tiles API" w Google Cloud Console.</small>`;
                }
            }
            return response;
        };

        // Funkcja do ustawiania kamery na konkretną lat/lon
        // Warszawa: 52.2319581, 21.0067249 (Pałac Kultury)
        tilesRenderer.setLatLonToYUp(52.2319581, 21.0067249);

        // Optymalizacja ładowania
        tilesRenderer.errorTarget = 12; // Mniejsza wartość = lepsza jakość, ale wolniej (domyślnie 6)
        tilesRenderer.loadSiblings = false;

        // --- ŚWIATŁO ---
        // Google Tiles są "unlit" (mają wypalone światło), ale możemy dodać atmosferę
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(100, 200, 50);
        scene.add(dirLight);

        const ambLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambLight);

        // --- POST-PROCESSING (PREMIUM LOOK) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.6; // Bloom tylko na jasnych elementach (okna, niebo)
        bloomPass.strength = 1.2;
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- HOLOGRAMY (FlowAssist) ---
        // Dodamy Twój napis FlowAssist unoszący się nad miastem
        function initHoloText() {
            const canvas = document.createElement('canvas');
            canvas.width = 2048; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(0,0,0,0)'; // przezroczyste tło
            ctx.fillRect(0, 0, canvas.width, canvas.height); // czyszczenie

            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.font = 'bold 300px sans-serif';
            ctx.fillText("FlowAssist", 1024, 400);
            ctx.font = 'bold 150px sans-serif';
            ctx.fillText("Real Estate AI", 1024, 700);

            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({
                map: tex,
                transparent: true,
                opacity: 0.9,
                color: 0x00ffff // Cyjanowy tint
            });
            const sprite = new THREE.Sprite(mat);
            // Wielki napis nad miastem
            sprite.scale.set(400, 200, 1);
            sprite.position.set(0, 300, 0); // Nad PKiN
            scene.add(sprite);

            // Dodatkowe cząsteczki / dron
            const sphereGeo = new THREE.SphereGeometry(10, 32, 32);
            const sphereMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
            const drone = new THREE.Mesh(sphereGeo, sphereMat);
            drone.position.set(50, 250, 50);
            scene.add(drone);
        }

        initHoloText();

        // --- GUI ---
        const gui = new GUI({ title: 'Ustawienia Demo' });
        const params = {
            bloomStrength: 1.2,
            exposure: 1.2,
            location: 'Warszawa',
            reload: () => window.location.reload()
        };

        gui.add(params, 'bloomStrength', 0, 3).onChange(v => bloomPass.strength = v);
        gui.add(params, 'exposure', 0, 3).onChange(v => renderer.toneMappingExposure = v);
        gui.add(params, 'location', ['Warszawa', 'Lwów', 'New York']).onChange(val => {
            // Prosta zmiana lokalizacji (wymaga przeładowania renderera w praktyce, tu uproszczone setLatLon)
            if (val === 'Warszawa') tilesRenderer.setLatLonToYUp(52.2319581, 21.0067249);
            if (val === 'Lwów') tilesRenderer.setLatLonToYUp(49.841952, 24.031599); // Rynek
            if (val === 'New York') tilesRenderer.setLatLonToYUp(40.7484, -73.9857); // Empire State
            // Reset kamery
            camera.position.set(0, 400, 600);
            controls.target.set(0, 0, 0);
        });

        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Wymagane aktualizowanie tilesów
            tilesRenderer.update();

            composer.render();
            // renderer.render(scene, camera); // Używamy composera
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>